# -*- coding: utf-8 -*-

from dataapiclient import Client
import tushare as ts
import pandas as pd
import json

def getStocks():
    stocks_df = ts.get_stock_basics()
    stocks = list(stocks_df.index)
    return stocks

def fetch(stock):
    try:
        client = Client()
        client.init('b3914afefef661cda6be2a6f897ce2676bd0596bb98a62c2afc15ffafd0836aa')
        url1='/api/equity/getEquIndustry.json?field=&industryVersionCD=010303&industry=&secID=' + stock
        code, result = client.getData(url1)
        if code==200:
            jsonObj = json.loads(result)
            if jsonObj['retCode'] == 1:
                df = pd.read_json(json.dumps(jsonObj['data']))
                df = df[df["isNew"] == 1]
                df = df.set_index(["secID"])
                return df["industryName1"]
        else:
            print code
            print result
    except Exception, e:
        #traceback.print_exc()
        print "Error:" + stock

def go():
    stocks = ['300498.XSHE', '300104.XSHE', '300059.XSHE', '300433.XSHE', '300017.XSHE', '300070.XSHE', '300033.XSHE', '300027.XSHE', '300024.XSHE', '300144.XSHE', '300251.XSHE', '300496.XSHE', '300418.XSHE', '300015.XSHE', '300072.XSHE', '300003.XSHE', '300124.XSHE', '300182.XSHE', '300408.XSHE', '300315.XSHE', '300267.XSHE', '300113.XSHE', '300133.XSHE', '300168.XSHE', '300296.XSHE', '300159.XSHE', '300122.XSHE', '300383.XSHE', '300001.XSHE', '300324.XSHE', '300085.XSHE', '300367.XSHE', '300146.XSHE', '300134.XSHE', '300266.XSHE', '300115.XSHE', '300058.XSHE', '300043.XSHE', '300014.XSHE', '300359.XSHE', '300253.XSHE', '300431.XSHE', '300002.XSHE', '300100.XSHE', '300136.XSHE', '300156.XSHE', '300474.XSHE', '300166.XSHE', '300244.XSHE', '300287.XSHE', '300088.XSHE', '300199.XSHE', '300291.XSHE', '300458.XSHE', '300207.XSHE', '300222.XSHE', '300459.XSHE', '300294.XSHE', '300274.XSHE', '300297.XSHE', '300463.XSHE', '300055.XSHE', '300450.XSHE', '300368.XSHE', '300010.XSHE', '300026.XSHE', '300098.XSHE', '300145.XSHE', '300376.XSHE', '300300.XSHE', '300369.XSHE', '300377.XSHE', '300347.XSHE', '300068.XSHE', '300101.XSHE', '300336.XSHE', '300197.XSHE', '300343.XSHE', '300009.XSHE', '300273.XSHE', '300188.XSHE', '300252.XSHE', '300302.XSHE', '300078.XSHE', '300269.XSHE', '300011.XSHE', '300307.XSHE', '300386.XSHE', '300484.XSHE', '300118.XSHE', '300438.XSHE', '300288.XSHE', '300032.XSHE', '300432.XSHE', '300257.XSHE', '300224.XSHE', '300339.XSHE', '300079.XSHE', '300073.XSHE', '300364.XSHE', '300271.XSHE', '300485.XSHE', '300171.XSHE', '300131.XSHE', '300216.XSHE', '300494.XSHE', '300037.XSHE', '300310.XSHE', '300203.XSHE', '300170.XSHE', '300183.XSHE', '300242.XSHE', '300317.XSHE', '300202.XSHE', '300351.XSHE', '300090.XSHE', '300429.XSHE', '300413.XSHE', '300284.XSHE', '300038.XSHE', '300256.XSHE', '300020.XSHE', '300178.XSHE', '300439.XSHE', '300208.XSHE', '300008.XSHE', '300292.XSHE', '300285.XSHE', '300467.XSHE', '300299.XSHE', '300392.XSHE', '300426.XSHE', '300045.XSHE', '300212.XSHE', '300114.XSHE', '300077.XSHE', '300406.XSHE', '300005.XSHE', '300229.XSHE', '300476.XSHE', '300004.XSHE', '300350.XSHE', '300495.XSHE', '300316.XSHE', '300238.XSHE', '300054.XSHE', '300373.XSHE', '300456.XSHE', '300173.XSHE', '300157.XSHE', '300311.XSHE', '300348.XSHE', '300109.XSHE', '300451.XSHE', '300342.XSHE', '300232.XSHE', '300147.XSHE', '300187.XSHE', '300441.XSHE', '300465.XSHE', '300352.XSHE', '300031.XSHE', '300097.XSHE', '300409.XSHE', '300219.XSHE', '300185.XSHE', '300053.XSHE', '300436.XSHE', '300363.XSHE', '300457.XSHE', '300353.XSHE', '300075.XSHE', '300358.XSHE', '300508.XSHE', '300278.XSHE', '300511.XSHE', '300012.XSHE', '300063.XSHE', '300327.XSHE', '300318.XSHE', '300366.XSHE', '300034.XSHE', '300379.XSHE', '300065.XSHE', '300481.XSHE', '300389.XSHE', '300469.XSHE', '300162.XSHE', '300362.XSHE', '300116.XSHE', '300149.XSHE', '300482.XSHE', '300036.XSHE', '300148.XSHE', '300048.XSHE', '300180.XSHE', '300039.XSHE', '300215.XSHE', '300410.XSHE', '300468.XSHE', '300127.XSHE', '300204.XSHE', '300466.XSHE', '300128.XSHE', '300160.XSHE', '300493.XSHE', '300491.XSHE', '300263.XSHE', '300333.XSHE', '300248.XSHE', '300419.XSHE', '300356.XSHE', '300023.XSHE', '300360.XSHE', '300276.XSHE', '300365.XSHE', '300471.XSHE', '300384.XSHE', '300424.XSHE', '300403.XSHE', '300497.XSHE', '300236.XSHE', '300326.XSHE', '300440.XSHE', '300477.XSHE', '300443.XSHE', '300096.XSHE', '300444.XSHE', '300155.XSHE', '300237.XSHE', '300378.XSHE', '300341.XSHE', '300223.XSHE', '300447.XSHE', '300196.XSHE', '300006.XSHE', '300332.XSHE', '300153.XSHE', '300448.XSHE', '300061.XSHE', '300502.XSHE', '300190.XSHE', '300091.XSHE', '300209.XSHE', '300298.XSHE', '300255.XSHE', '300279.XSHE', '300016.XSHE', '300233.XSHE', '300050.XSHE', '300449.XSHE', '300314.XSHE', '300394.XSHE', '300381.XSHE', '300479.XSHE', '300250.XSHE', '300151.XSHE', '300473.XSHE', '300064.XSHE', '300130.XSHE', '300325.XSHE', '300304.XSHE', '300206.XSHE', '300380.XSHE', '300388.XSHE', '300355.XSHE', '300057.XSHE', '300301.XSHE', '300328.XSHE', '300056.XSHE', '300213.XSHE', '300258.XSHE', '300110.XSHE', '300066.XSHE', '300399.XSHE', '300507.XSHE', '300247.XSHE', '300289.XSHE', '300420.XSHE', '300499.XSHE', '300490.XSHE', '300398.XSHE', '300028.XSHE', '300295.XSHE', '300486.XSHE', '300427.XSHE', '300198.XSHE', '300455.XSHE', '300221.XSHE', '300119.XSHE', '300071.XSHE', '300231.XSHE', '300503.XSHE', '300506.XSHE', '300414.XSHE', '300007.XSHE', '300261.XSHE', '300217.XSHE', '300205.XSHE', '300245.XSHE', '300195.XSHE', '300462.XSHE', '300201.XSHE', '300081.XSHE', '300047.XSHE', '300393.XSHE', '300189.XSHE', '300357.XSHE', '300425.XSHE', '300052.XSHE', '300111.XSHE', '300264.XSHE', '300150.XSHE', '300163.XSHE', '300049.XSHE', '300396.XSHE', '300141.XSHE', '300346.XSHE', '300143.XSHE', '300230.XSHE', '300018.XSHE', '300181.XSHE', '300108.XSHE', '300335.XSHE', '300234.XSHE', '300319.XSHE', '300395.XSHE', '300435.XSHE', '300194.XSHE', '300025.XSHE', '300262.XSHE', '300303.XSHE', '300446.XSHE', '300021.XSHE', '300309.XSHE', '300135.XSHE', '300074.XSHE', '300475.XSHE', '300505.XSHE', '300290.XSHE', '300331.XSHE', '300329.XSHE', '300293.XSHE', '300277.XSHE', '300272.XSHE', '300349.XSHE', '300129.XSHE', '300510.XSHE', '300404.XSHE', '300411.XSHE', '300437.XSHE', '300306.XSHE', '300334.XSHE', '300086.XSHE', '300452.XSHE', '300470.XSHE', '300094.XSHE', '300480.XSHE', '300137.XSHE', '300501.XSHE', '300246.XSHE', '300390.XSHE', '300509.XSHE', '300193.XSHE', '300165.XSHE', '300430.XSHE', '300041.XSHE', '300158.XSHE', '300370.XSHE', '300040.XSHE', '300407.XSHE', '300259.XSHE', '300095.XSHE', '300172.XSHE', '300076.XSHE', '300500.XSHE', '300338.XSHE', '300382.XSHE', '300345.XSHE', '300099.XSHE', '300488.XSHE', '300067.XSHE', '300030.XSHE', '300138.XSHE', '300487.XSHE', '300445.XSHE', '300044.XSHE', '300460.XSHE', '300167.XSHE', '300117.XSHE', '300154.XSHE', '300375.XSHE', '300442.XSHE', '300401.XSHE', '300385.XSHE', '300184.XSHE', '300374.XSHE', '300453.XSHE', '300489.XSHE', '300265.XSHE', '300270.XSHE', '300140.XSHE', '300112.XSHE', '300042.XSHE', '300422.XSHE', '300434.XSHE', '300400.XSHE', '300249.XSHE', '300240.XSHE', '300415.XSHE', '300169.XSHE', '300080.XSHE', '300175.XSHE', '300123.XSHE', '300139.XSHE', '300019.XSHE', '300211.XSHE', '300239.XSHE', '300412.XSHE', '300210.XSHE', '300305.XSHE', '300241.XSHE', '300089.XSHE', '300280.XSHE', '300478.XSHE', '300235.XSHE', '300464.XSHE', '300492.XSHE', '300416.XSHE', '300428.XSHE', '300286.XSHE', '300254.XSHE', '300283.XSHE', '300179.XSHE', '300483.XSHE', '300069.XSHE', '300103.XSHE', '300227.XSHE', '300281.XSHE', '300121.XSHE', '300371.XSHE', '300421.XSHE', '300107.XSHE', '300354.XSHE', '300225.XSHE', '300087.XSHE', '300320.XSHE', '300417.XSHE', '300218.XSHE', '300176.XSHE', '300174.XSHE', '300035.XSHE', '300387.XSHE', '300200.XSHE', '300472.XSHE', '300243.XSHE', '300132.XSHE', '300461.XSHE', '300260.XSHE', '300062.XSHE', '300321.XSHE', '300214.XSHE', '300423.XSHE', '300192.XSHE', '300391.XSHE', '300022.XSHE', '300106.XSHE', '300125.XSHE', '300120.XSHE', '300308.XSHE', '300046.XSHE', '300372.XSHE']
    # for stock in stocks:
    #     if int(stock) > 2506:
    industrys = pd.Series()
    for i in range(0,5):
        to = (i+1)*100
        if to > len(stocks):
            to = -1
        stocks_a = stocks[i*50:to]
        stocks_str = ""
        for stock in stocks_a:
            stocks_str += stock + ","
        industry = fetch(stocks_str)
        for idx in industry.index:
            industrys[idx] = industry[idx]

    output = "{"
    for index in industrys.index:
        output += "\"" + index + "\":\"" + industrys[index] + "\","
    output = output[:-1]
    output += "}"
    print output
    df = pd.DataFrame()
    df["industry"] = industrys
    df.to_csv("industry.csv")

go()
